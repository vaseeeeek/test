function shopCityselectFrontend(){var r=this;r.token="",r.url="",r.lib="",r.bounds="city",r.disable_auto=0,r.show_notifier="auto",r.$notifiers=null,r.notifier_type="notifier",r.is_open_modal=!1,r.modal_type=!1,r.remodal_instance=null,r.is_detect=!1,r.by_detect=!1,r.in_checkout=!0,r.in_order=!1,r.in_custom_form=".wa-signup-form-fields,.quickorder-form,#storequickorder .wa-form",r.in_custom_city="",r.plugin_dp=!1,r.is_redirecting=!1,r.location=null,r.find={country:'[name$="country]"]',region:'[name$="region]"]',city:'[name$="city]"]',zip:'[name$="zip]"]',street:'[name$="street]"]'},r.save_street=null,r.init=function(t,e,i,n,o,a,c,s){r.token=t,r.url=e,r.lib=i,r.bounds=n,r.show_notifier=o,r.in_checkout=!!a,r.plugin_dp=!!c,r.disable_auto=!!s,"force"==r.show_notifier&&$(document).ready(function(){r.showNotifiers()}),$(document).ready(function(){r.in_checkout&&r.initWaAddress(),(r.in_custom_form||r.in_custom_city)&&(setInterval(function(){r.initWaCustom()},500),r.initWaCustom()),r.themeSupport()}),r.plugin_dp&&$(document).on("click",".js-dp-city-select",function(t){return t.preventDefault(),t.stopImmediatePropagation(),r.changeCity(),!1})},r.initStreet=function(e,i,n,t){var o={};r.location.constraints_street?o.kladr_id=r.location.constraints_street:(i.length&&(o.city=String(i.val()).trim()),t&&t.length&&(o.kladr_id=t.val())),e.suggestions({token:r.token,type:"ADDRESS",scrollOnFocus:!1,constraints:{label:"",locations:o},restrict_value:!0,onSelect:function(t){t.data.postal_code&&n.length&&n.val(t.data.postal_code),t.data.settlement?t.data.settlement!=i.val()&&(i.val(t.data.settlement),r.updateStreetConstraints(t,e),r.setCity(t.data,i)):t.data.city&&t.data.city!=i.val()&&(i.val(t.data.city),r.updateStreetConstraints(t,e),r.setCity(t.data,i)),e.change()}})},r.initCity=function(e){e.addClass("i-cityselect__custom-city--init"),e.length&&e.suggestions({token:r.token,type:"ADDRESS",hint:!1,bounds:r.bounds,constraints:{label:""},scrollOnFocus:!1,formatSelected:function(t){return t.data.settlement?t.data.settlement:t.data.city},onSelect:function(t){e.data("cityselect-not-set")||(r.by_detect=!1,r.setCity(t.data))}})},r.updateStreetConstraints=function(t,e){var i=e.suggestions();if(i){var n={};t.data.settlement?n.kladr_id=t.data.settlement_kladr_id:n.kladr_id=t.data.city_kladr_id,i.setOptions({constraints:{locations:n}}),i.fixData()}},r.initAddress=function(i){i.addClass("i-cityselect__wa--init");i.find(r.find.country);var n=i.find(r.find.city),o=i.find(r.find.street),a=i.find(r.find.zip),c=i.find(r.find.region);if(n.length){var t={token:r.token,type:"ADDRESS",hint:!1,bounds:r.bounds,constraints:{label:""},formatSelected:function(t){return t.data.settlement?t.data.settlement:t.data.city},onSelect:function(t){if((c=n.closest(".i-cityselect__wa--init").find(r.find.region)).length&&t.data.region_kladr_id){var e=String(t.data.region_kladr_id).substr(0,2);if(c.val()!=e)c.val(e).change(),n.suggestions().setOptions({geoLocation:{kladr_id:e}})}t.data.postal_code&&a.length&&a.val(t.data.postal_code),o.length&&r.updateStreetConstraints(t,o),i.data("cityselect-not-set")||(r.by_detect=!1,r.setCity(t.data,n))}};c.length&&(t.geoLocation={kladr_id:String(c.val()).substr(0,2)}),n.suggestions(t)}o.length&&r.initStreet(o,n,a,c)},r.initWaAddress=function(){$(".wa-address,.wa-field-address").not(".i-cityselect__wa--init").each(function(){r.initAddress($(this))}),$(".wa-step-region-section").not(".i-cityselect__wa--init").each(function(){r.initRegionAddress($(this))}),$(".wa-step-details-section").not(".i-cityselect__wa--init").each(function(){r.initDetailsAddress($(this))})},r.themeSupport=function(){var t=$(".base-menu .b-cityselect__wrapper--profitbuy i.fa,.base-menu .b-cityselect__wrapper--profitbuy1 i.fa");t.length&&t.replaceWith('<i class="material-icons">&#xE55F;</i>');var e=!1,i=$(".b-cityselect__wrapper--incart,.b-cityselect__wrapper--incart1,.b-cityselect__wrapper--incart2");i.length&&(i.find(".b-cityselect__city i").replaceWith('<div class="info-settings__icon"><svg class="icon icon-location" width="16" height="14"><use xlink:href="#icon-location"></use></svg></div>'),e=!0),(i=$(".top-bar__info-settings .b-cityselect__wrapper")).length&&(i.addClass("info-settings__btn info-settings__btn--account info-settings__btn--signed"),i.find(".b-cityselect__city .i-cityselect__city").addClass("info-settings__text"),i.find(".b-cityselect__city").removeClass("b-cityselect__city").addClass("info-settings__btn-inner"),e=!0),e&&$(".top-menu__list").trigger("resize")},r.closeModal=function(){"fancybox"==r.modal_type&&$.fancybox.close(!0),"remodal"==r.modal_type&&r.remodal_instance&&(r.remodal_instance.close(),$(".stek35-container").length&&(r.remodal_instance.destroy(),r.remodal_instance=null)),"magnificPopup"==r.modal_type&&$.magnificPopup.instance.close(),r.modal_type=!1},r.initRegionAddress=function(t){t.addClass("i-cityselect__wa--init");var e=t.find(r.find.country),i=t.find(r.find.region),n=t.find(r.find.city),o=t.find(r.find.zip);if(e.length&&"rus"!=e.val())return!1;if(n.length){var a={token:r.token,type:"ADDRESS",hint:!1,bounds:r.bounds,constraints:{label:""},scrollOnFocus:!1,triggerSelectOnBlur:!1,formatSelected:function(t){return t.data.settlement?t.data.settlement:t.data.city},onSelect:function(t){var e=n.closest(".i-cityselect__wa--init").find(r.find.region);if(e.length&&t.data.region_kladr_id){var i=String(t.data.region_kladr_id).substr(0,2);if(e.val()!=i)e.val(i),n.suggestions().setOptions({geoLocation:{kladr_id:i}})}t.data.postal_code&&o.length&&o.val(t.data.postal_code),r.by_detect=!1,r.setCity(t.data,n)}};i.length&&(a.geoLocation={kladr_id:String(i.val()).substr(0,2)}),n.suggestions(a)}},r.initDetailsAddress=function(t){t.addClass("i-cityselect__wa--init");var e=t.find(r.find.street);if(e.length){var i=$(".wa-step-region-section .js-city-field"),n=t.find(r.find.zip);r.initStreet(e,i,n)}},r.initChangeInput=function(){$(".i-cityselect__input").suggestions({token:r.token,type:"ADDRESS",hint:!1,bounds:r.bounds,scrollOnFocus:!1,constraints:{label:""},formatSelected:function(t){return t.data.city},onSelect:function(t){r.by_detect=!1,r.setCity(t.data,$(this)),r.closeModal(),r.hideNotifiers()}})},r.openByFancybox=function(t){r.modal_type="fancybox",$.fancybox.open({type:"ajax",href:t,src:t,afterShow:function(){r.initChangeInput()},afterClose:function(){r.modal_type=!1}})},r.openModal=function(t){if($(".b-cityselect__wrapper--profitbuy,.b-cityselect__wrapper--profitbuy1,.b-cityselect__wrapper--profitbuy2").length)return r.openByFancybox(t);if($.remodal)r.modal_type="remodal",r.remodal_instance&&(r.remodal_instance.destroy(),r.remodal_instance=null),$("#cityselect__change").length&&$("#cityselect__change").remove(),$.get(t,function(t){$("body").append(t),r.remodal_instance=$("#cityselect__change").on("opened",function(){r.initChangeInput()}).on("closed",function(){r.remodal_instance&&(r.remodal_instance.destroy(),r.remodal_instance=null)}).remodal(),r.remodal_instance.open()});else if($.fancybox)r.openByFancybox(t);else if($.magnificPopup)r.modal_type="magnificPopup",$.magnificPopup.open({type:"ajax",overflowY:"scroll",closeBtnInside:!0,items:{src:t},callbacks:{parseAjax:function(t){t.data='<div class="b-cityselect__mfp">'+t.data+"</div>"},ajaxContentAdded:function(){r.initChangeInput()}}});else{var e=$("<link/>",{rel:"stylesheet",type:"text/css",href:r.lib+"jquery.fancybox.css"});e.appendTo("head"),e[0].onload=function(){$.getScript(r.lib+"jquery.fancybox.pack.js",function(){r.openByFancybox(t)})}}},r.updateCheckout=function(t){t.country&&($('[name$="[address.shipping][country]"]').val(t.country).change(),$(".js-country-field").val(t.country)),t.region&&($('[name$="[address.shipping][region]"]').val(t.region).change(),$(".js-region-field").val(t.region)),t.city&&($('[name$="[address.shipping][city]"]').val(t.city).change(),$(".js-city-field").val(t.city),$('[name$="[address.shipping][zip]"]').val(t.zip?t.zip:"").change(),$('[name$="[shipping_address][zip]"]').val(t.zip?t.zip:"").change(),$(".js-zip-field").val(t.zip?t.zip:"")),$(".js-city-field").trigger("region_change")},r.updateVariables=function(t){if(t.variables)for(var e in t.variables){var i=t.variables[e],n=!1;try{var o=String(i.code);o="updateVariable"+o.charAt(0).toUpperCase()+o.slice(1),r[o]&&(r[o](i),n=!0)}catch(t){console.log(t)}n||$(".i-cityselect__var--"+i.code).replaceWith(i.html)}},r.changeCity=function(){r.openModal(r.url+"shop_cityselect/change_city")},r.setCity=function(t,n){if(!1!==t){var e=t.settlement?t.settlement:t.city;$(".i-cityselect__city").html(e)}else t={set_default:1};t.route_params=r.route_params,$.post(r.url+"shop_cityselect/set_city",t,function(t){if(t.status&&"ok"===t.status){if(r.location=t.data,r.updateVariables(t.data),r.onSetCity&&(t.data=r.onSetCity(t.data)),t.data&&r.updateCheckout(t.data),n&&n.length&&n.closest("body").length||(n=$(document)),t.data.redirect&&(r.is_redirecting=!0,r.by_detect&&(r.show_notifier="none"),t.data.save_cookie)){var e=document.createElement("img");e.onload=function(){window.location.href=t.data.redirect_url},e.onerror=function(){window.location.href=t.data.redirect_url};var i=t.data.save_cookie+"?t="+Math.random()+"&"+t.data.save_data;r.by_detect&&(i+="&cityselect__force_notify=1"),e.src=i}r.by_detect&&"none"!=r.show_notifier&&r.showNotifiers(),n.trigger("cityselect__set_city",t.data)}})},r.moveNotifier=function(t,e){t.data("delta-right",e),t.css("transform","translateX("+e+"px)"),t.find(".b-cityselect__notifier_triangle").css("transform","translateX("+-e+"px)")},r.boundsNotifiers=function(){r.$notifiers&&r.$notifiers.length&&r.$notifiers.each(function(){var t=$(this);t.data("delta-right")&&r.moveNotifier(t,0);var e=t.offset().left+t.outerWidth(!0)+1;if(e>$(window).width()){var i=$(window).width()-e;r.moveNotifier(t,i)}})},r.showNotifiers=function(){"modal"==r.notifier_type?$(".i-cityselect__notifier--modal").first().appendTo("body").modal():(r.$notifiers=$(".b-cityselect__notifier"),r.$notifiers.show(),r.boundsNotifiers()),$.post(r.url+"shop_cityselect/show_notifier")},r.hideNotifiers=function(){"modal"==r.notifier_type?$(".i-cityselect__notifier--modal").modal("hide"):r.$notifiers&&r.$notifiers.length?r.$notifiers.hide():$(".b-cityselect__notifier").hide()},r.detectCity=function(){var t={type:"GET",contentType:"application/json",headers:{Authorization:"Token "+r.token}};return $.ajax("https://suggestions.dadata.ru/suggestions/api/4_1/rs/detectAddressByIp",t)},r.findAddressByFiasId=function(t){var e={query:t},i={type:"POST",contentType:"application/json",headers:{Authorization:"Token "+r.token},data:JSON.stringify(e)};return $.ajax("https://suggestions.dadata.ru/suggestions/api/4_1/rs/findById/address",i)},r.detect=function(){r.is_detect||(r.is_detect=!0,r.disable_auto||r.detectCity().done(function(t){if(r.by_detect=!0,t.location&&t.location.data){var e=t.location.data;r.findAddressByFiasId(e.fias_id).done(function(t){t.suggestions[0]&&(e=t.suggestions[0].data),r.setCity(e)})}else r.setCity(!1)}))},r.setLocation=function(t){var e=t.find(r.find.country),i=t.find(r.find.region),n=t.find(r.find.city),o=t.find(r.find.zip);r.location.country&&e.val(r.location.country),r.location.region&&i.val(r.location.region),r.location.city&&n.val(r.location.city),r.location.zip&&o.val(r.location.zip)},r.initWaCustom=function(){r.in_custom_form&&$(r.in_custom_form).not(".i-cityselect__wa--init").each(function(){r.initAddress($(this)),r.setLocation($(this))}),r.in_custom_city&&$(r.in_custom_city).not(".i-cityselect__custom-city--init").each(function(){var t=$(this);r.initCity(t),r.location.city&&t.val(r.location.city)})},$(document).on("click",".i-cityselect__city_yes",function(t){t.preventDefault(),r.hideNotifiers(),$.post(r.url+"shop_cityselect/say_yes")}),$(document).on("click",".i-cityselect__city_no",function(t){t.preventDefault(),r.hideNotifiers(),$(".i-cityselect__city_change").first().click()}),$(document).on("click",".i-cityselect__city_change",function(t){t.preventDefault(),r.hideNotifiers(),r.changeCity()}),$(document).on("click",".i-cityselect__change_close",function(t){t.preventDefault(),r.closeModal()}),$(document).on("click",".i-cityselect__set_city",function(t){t.preventDefault(),r.by_detect=!1,r.setCity($(this).data(),$(this)),r.closeModal()}),$(document).on("cityselect__set_city",function(t){!r.plugin_dp||!window.shop_dp||r.is_redirecting||r.by_detect||$(t.target).closest(".quickorder-form").length||location.reload()}),$(document).on("cityselect__set_city",function(t,e){r.in_custom_form&&$(r.in_custom_form).each(function(){var t=$(this);t.find(r.find.country).val(e.country||""),t.find(r.find.region).val(e.region||""),t.find(r.find.city).val(e.city||""),t.find(r.find.zip).val(e.zip||"")}),r.in_custom_city&&$(r.in_custom_city).each(function(){$(this).val(e.city||"")})}),$(window).resize(function(){r.boundsNotifiers()}),$(document).on("wa_order_form_ready",function(t){r.in_checkout&&r.initWaAddress()}),$(document).on("wa_order_form_region_changed",function(){r.in_checkout&&r.initWaAddress()}),$(document).on("wa_order_form_details_changed",function(){r.in_checkout&&r.initWaAddress()})}var shop_cityselect=new shopCityselectFrontend;