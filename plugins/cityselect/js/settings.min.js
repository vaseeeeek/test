function SettingsEchoCompany(){var s=this;s.saveCode=function(){return $(".i-settings__code").each(function(){$(this).data("editor")&&$(this).data("editor").save()}),!0},s.addItem=function(t,e,i,n){var s=(n=n?" checked ":"")?"1":"0",o=$("#city_field__template").html();o=(o=(o=(o=(o=o.replace(new RegExp("%city%","g"),t)).replace(new RegExp("%region%","g"),e)).replace(new RegExp("%zip%","g"),i)).replace(new RegExp("%bold%","g"),n)).replace(new RegExp("%bold_id%","g"),s),$(".i-settings__city_list").append(o).sortable("refresh")},s.refreshCode=function(){$(".i-settings__code").each(function(){$(this).data("editor")&&($(this).data("editor").refresh(),$(this).data("editor").refresh())})},s.initCode=function(){$(".i-settings__code").each(function(){var t=$(this);if(!t.data("editor")){var e=t.data("mode")?t.data("mode"):"text/html",i=CodeMirror.fromTextArea(this,{mode:e,tabMode:"indent",height:"dynamic",lineWrapping:!0,extraKeys:{"Ctrl+S":function(t){alert(t)}}});t.data("editor",i)}})},s.initColor=function(e){var t,i=$('<span class="color-replacer"><i class="icon16 color" style="background: #'+e.val().substr(1)+'"></i></span>').insertAfter(e),n=$('<div style="display:none;" class="color-picker"></div>').insertAfter(i),s=$.farbtastic(n,function(t){i.find("i").css("background",t),e.val(t)});s.setColor("#"+e.val()),i.click(function(){return n.slideToggle(200),!1}),e.unbind("keydown").bind("keydown",function(){t&&clearTimeout(t),t=setTimeout(function(){s.setColor(e.val())},250)})},s.initRoute=function(){$(".i-settings__color").each(function(){s.initColor($(this)),s.initCode()}),s.initCode(),$.wa.errorHandler=function(t){},$(".i-settings__city").suggestions({token:$("#current__token").val(),type:"ADDRESS",hint:!1,bounds:"city",constraints:{label:""},globals:!1,formatSelected:function(t){return t.data.city},onSelect:function(t){$(".i-settings__zip").val(t.data.postal_code),$(".i-settings__region").val(String(t.data.region_kladr_id).substr(0,2)),$(".i-settings__add").click()}}),$(".b-sortable").sortable({placeholder:"ui-state-highlight"}),$(".b-sortable").disableSelection()},s.init=function(){CodeMirror.commands.save=function(){$('#plugins-settings-form input[type="submit"]').click()},$(".i-settings__warning").on("change keyup",function(t){var e=$(this).val();"0"!=e&&""!=e?$(".i-settings__warning_message").stop(!1,!1).slideDown():$(".i-settings__warning_message").stop(!1,!1).slideUp()}),$(".i-settings__color").each(function(){s.initColor($(this))}),$(document).on("click",".i-settings__tabs .tabs a",function(t){$(this).closest(".tabs").find(".selected").removeClass("selected"),$(this).parent().addClass("selected");var e=$(this).closest(".i-settings__tabs");e.find(".i-settings__tab").hide();var i=$(this).data("tab");e.find('.i-settings__tab[data-tab="'+i+'"]').show(),$.cookie(e.data("cookie"),i,{expires:356,path:"/"}),e.find(".i-settings__tab_current").val(i),s.refreshCode(),t.preventDefault()}),$(document).off("change",".i-settings__checkbox").on("change",".i-settings__checkbox",function(){var t=$(this).is(":checked")?1:0;if($(this).parent().find("input[type=hidden]").val(t),$(this).data("target")){var e=$("[data-relative="+$(this).data("target")+"]");1==t?(e.show(),s.refreshCode()):e.hide()}});var e=$(".i-settings__load"),i=$(".i-settings__reset"),n=$(".i-settings__routes");n.change(function(){e.html('<i class="icon16 loading"></i>');var t=$(this).val();"0"==t?i.hide():i.show(),$.get(n.data("url")+"&current_route="+t,function(t){e.html(t),s.initRoute()})}).change(),i.click(function(t){t.preventDefault(),confirm(i.data("confirm"))&&(e.html('<i class="icon16 loading"></i>'),$.get(n.data("url")+"&reset=1&current_route="+n.val(),function(t){e.html(t),s.initRoute()}))}),$(document).on("change",".i-settings__upload input[type=file]",function(){var t=$(this),e=t.closest(".i-settings__upload"),i=e.find(".i-settings__upload_loading"),n=e.find(".i-settings__upload_error"),s=new FormData,o=e.closest("form").find("[name=_csrf]").val();s.append("_csrf",o),s.append("type",e.data("type")),s.append("file",t[0].files[0]),t.hide(),n.hide(),i.show(),$.ajax({url:e.data("url"),data:s,type:"POST",contentType:!1,processData:!1,global:!1,dataType:"json",success:function(t){"ok"==t.status?(e.find(".i-settings__upload_value").val(t.url),e.find(".i-settings__upload_image").attr("src",t.url),e.find(".i-settings__upload_image_block").show()):n.show().html(n.data("error")+": "+t.error)}}).fail(function(){n.show().html(n.data("error"))}).always(function(){t.show().val(""),i.hide()})}),$(document).on("click",".i-settings__upload_delete",function(t){t.preventDefault();var e=$(this).closest(".i-settings__upload");e.find(".i-settings__upload_value").val(""),e.find(".i-settings__upload_image").attr("src",""),e.find(".i-settings__upload_image_block").hide()}),$(document).on("change",".i-settings__select",function(t){var e=$(this).data("target");e&&($("."+e).hide(),$("."+e+"--"+$(this).val()).show())}),$(document).on("change",".i-settings__multi_checkbox",function(t){var e=$(this).closest(".field"),i=e.find(".i-settings__multi_checkbox:checked").map(function(){return this.value}).get().join(",");e.find('input[type="hidden"]').val(i)}),$(document).off("click",".i-settings__copy_code").on("click",".i-settings__copy_code",function(){var t=$('<input class="b-settings__copy_code_input" style="font-weight: bold; vertical-align: baseline;min-width:0;border: 1px solid #ccc; padding: 1px; width:'+($(this).width()+2)+'px !important" type="text" readonly="readonly" />').val($(this).text()).focus(function(){$(this).select()}).mouseup(function(t){t.preventDefault()});$(this).replaceWith(t),t.select()}),$(document).off("click",".i-settings__reset_css").on("click",".i-settings__reset_css",function(t){t.preventDefault(),confirm($(this).data("confirm"))&&(e.html('<i class="icon16 loading"></i>'),$.get(n.data("url")+"&reset_css=1&current_route="+n.val(),function(t){e.html(t),s.initRoute()}))}),$(document).off("click",".i-settings__reset_js").on("click",".i-settings__reset_js",function(t){t.preventDefault(),confirm($(this).data("confirm"))&&(e.html('<i class="icon16 loading"></i>'),$.get(n.data("url")+"&reset_js=1&current_route="+n.val(),function(t){e.html(t),s.initRoute()}))}),$(document).off("click",".i-settings__reset_templates").on("click",".i-settings__reset_templates",function(t){t.preventDefault(),confirm($(this).data("confirm"))&&(e.html('<i class="icon16 loading"></i>'),$.get(n.data("url")+"&reset_templates="+$(this).data("templates")+"&current_route="+n.val(),function(t){e.html(t),s.initRoute()}))}),$(document).on("click",".i-cityselect-city__delete",function(t){t.preventDefault(),confirm($(this).data("confirm"))&&($(this).closest(".i-cityselect-city").remove(),$(this).closest(".b-sortable").sortable("refresh"))}),$(document).on("click",".i-settings__add",function(t){var e=$(".i-settings__city").val(),i=$(".i-settings__region").val(),n=$(".i-settings__zip").val();""!=e?""!=i?(s.addItem(e,i,n,$(".i-settings__select").is(":checked")),$(".i-settings__city").val(""),$(".i-settings__region").val(""),$(".i-settings__zip").val("")):$(".i-settings__region").focus():$(".i-settings__city").focus()}),$(document).on("click",".i-settings__submenu",function(t){t.preventDefault();var e=$(this),i="i-settings__sub_content--active",n=$("."+i),s=$(".i-settings__sub_content--"+e.data("target"));n.is(s)||n.slideUp("fast",function(){n.removeClass(i),s.addClass(i).slideDown("fast")})}),$(document).off("click",".i-cityselect__delete_variables_type").on("click",".i-cityselect__delete_variables_type",function(t){t.preventDefault();var e=$(this);confirm(e.data("confirm"))&&$.post("?plugin=cityselect&module=settings&action=deleteVariablesType",e.data(),function(){$(".i-cityselect__variables_type--"+e.data("id")).remove()})}),$(document).off("click",".i-cityselect__delete_region").on("click",".i-cityselect__delete_region",function(t){t.preventDefault();var e=$(this);confirm(e.data("confirm"))&&$.post("?plugin=cityselect&module=settings&action=deleteRegion",e.data(),function(){$(".i-cityselect__region--"+e.data("id")).remove()})}),$(document).off("click",".i-cityselect__change_variables_type").on("click",".i-cityselect__change_variables_type",function(t){t.preventDefault(),$.get("?plugin=cityselect&module=settings&action=editVariablesType",$(this).data(),function(t){$(t).waDialog({onLoad:function(){s.initCode()},onSubmit:function(n){return $.post("?plugin=cityselect&module=settings&action=saveVariablesType",$(this).serialize(),function(t){if("ok"!=t.status)$(".i-dialog__error").show(),$(".i-dialog__error_text").html(t.error);else{var e=t.id,i=$(".i-cityselect__variables_type--"+e);i.length?i.replaceWith(t.html):$(".i-cityselect__variables_type_list").append(t.html),n.trigger("close")}},"json"),!1},disableButtonsOnSubmit:!0,buttons:'<button type="submit" class="button green">Сохранить</button> <input type="button" value="Закрыть" class="button cancel" /> <span class="i-dialog__error b-settings__dialog_error red" style="display: none"><i class="icon16 exclamation-red"></i> <span class="i-dialog__error_text"></span></span>',height:"240px",width:"420px"})})}),$(document).off("change","#cityselect__variables_type_code").on("change","#cityselect__variables_type_code",function(){var t=$(this);$(".i-settings__replace_code").text(t.val())}),$(document).off("click",".i-cityselect__change_region").on("click",".i-cityselect__change_region",function(t){t.preventDefault(),$.get("?plugin=cityselect&module=settings&action=editRegion",$(this).data(),function(t){$(t).waDialog({onLoad:function(){s.initCode(),$("#current__token").val()?($(".i-cityselect__form_region_token").hide(),$("#cityselect__region_city").suggestions({token:$("#current__token").val(),type:"ADDRESS",hint:!1,bounds:"city",constraints:{label:""},globals:!1,formatSelected:function(t){return t.data.city},onSelect:function(t){$("#cityselect__region_region").val(String(t.data.region_kladr_id).substr(0,2));var e={id:$(".i-cityselect__form_region_id").val(),region:$("#cityselect__region_region").val(),city:$("#cityselect__region_city").val()};$.post("?plugin=cityselect&module=settings&action=checkRegion",e,function(t){"ok"!=t.status?($(".i-dialog__error").show(),$(".i-dialog__error_text").html(t.error)):$(".i-dialog__error").hide()},"json")}})):$(".i-cityselect__form_region_token").show()},onSubmit:function(n){return $(".i-dialog__error").hide(),$.post("?plugin=cityselect&module=settings&action=saveRegion",$(this).serialize(),function(t){if("ok"!=t.status)$(".i-dialog__error").show(),$(".i-dialog__error_text").html(t.error);else{var e=t.id,i=$(".i-cityselect__region--"+e);i.length?i.replaceWith(t.html):$(".i-cityselect__regions_list").append(t.html),n.trigger("close")}},"json"),!1},onClose:function(){this.remove()},disableButtonsOnSubmit:!0,buttons:'<button type="submit" class="button green">Сохранить</button> <input type="button" value="Закрыть" class="button cancel" /> <span class="i-dialog__error b-settings__dialog_error red" style="display: none"><i class="icon16 exclamation-red"></i> <span class="i-dialog__error_text"></span></span>',width:"420px"})})})},$(document).ready(function(){s.init()})}var settings__echo_company=new SettingsEchoCompany;